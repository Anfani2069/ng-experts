<div class="min-h-screen bg-background pb-20 font-sans">

  <!-- Main Container -->
  <div class="expert-details-container px-6 md:px-20 pt-10 relative">
    <!-- Noise overlay anchored to container -->
    <div class="noise-overlay opacity-20"></div>

    <!-- Loading State -->
    @if (loading()) {
    <div class="flex items-center justify-center min-h-[60vh]">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-t-2 border-primary mb-4"></div>
        <p class="text-subtext text-sm font-medium">Chargement du profil expert...</p>
      </div>
    </div>
    }

    <!-- Content Loaded -->
    @if (!loading() && expertData()) {
    <!-- 2-column layout wrapping EVERYTHING -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-16 items-start">

      <!-- LEFT COLUMN: Main Content (8/12) -->
      <div class="lg:col-span-8 animate-fadeInUp">

        <!-- Breadcrumb -->
        <div class="flex items-center gap-2 text-[11px] font-bold uppercase tracking-widest text-subtext mb-10">
          <a (click)="goBack()" class="hover:text-white transition-colors cursor-pointer">All Experts</a>
          <span class="opacity-30">›</span>
          <span class="text-white/60">{{ fullName() }}</span>
        </div>

        <!-- Page Title -->
        <div class="mb-4">
          <h1 class="text-5xl md:text-6xl font-bold text-white tracking-tight leading-tight">{{ fullName() }}</h1>
        </div>

        <!-- Company / Role line -->
        <div class="flex items-center gap-3 mb-4">
          @if (expertData()?.avatar) {
          <img [src]="userAvatar()" [alt]="fullName()" class="w-7 h-7 rounded-full object-cover border border-white/10">
          }
          <span class="text-white font-semibold text-sm">{{ jobTitle() }}</span>
        </div>

        <!-- Meta bar -->
        <div class="flex flex-wrap items-center gap-2 text-subtext text-sm mb-16">
          <span>{{ fullLocation() }}</span>
          <span class="opacity-30">|</span>
          <span>{{ workPreferenceLabel() }}</span>
          @if (expertData()?.yearsOfExperience) {
          <span class="opacity-30">|</span>
          <span class="flex items-center gap-1">
            <i class="fa-solid fa-briefcase text-primary text-[10px]"></i>
            {{ expertData()?.yearsOfExperience }}
          </span>
          }
          <span class="opacity-30">|</span>
          <span class="flex items-center gap-1">
            <i class="fa-solid fa-star text-yellow-500 text-[10px]"></i>
            {{ rating() }} ({{ reviewsCount() }} avis)
          </span>
          @if (expertData()?.availability?.dailyRate) {
          <span class="opacity-30">|</span>
          <span class="text-white font-bold">{{ expertData()?.availability?.dailyRate }}€ / jour</span>
          }
        </div>

        <!-- Sections -->
        <div class="space-y-16">

          <!-- À PROPOS -->
          <section>
            <h3 class="section-title">À propos</h3>
            <div class="text-white/70 leading-relaxed max-w-2xl whitespace-pre-line text-[15px]">
              {{ expertData()?.bio || "Cet expert n'a pas encore renseigné sa présentation." }}
            </div>
          </section>

          <!-- EXPERTISE TECHNIQUE -->
          <section>
            <h3 class="section-title">Expertise technique</h3>
            <div class="flex flex-wrap gap-3">
              @for (skill of expertData()?.skills || []; track skill.id) {
              <span
                class="px-5 py-2 rounded-full bg-white/5 border border-white/10 text-white/80 font-medium text-sm hover:border-primary/30 hover:text-white transition-colors">
                {{ skill.name }}
              </span>
              }
            </div>
          </section>

          <!-- PARCOURS -->
          <section>
            <h3 class="section-title">Parcours</h3>
            <div class="space-y-10">
              @for (exp of sortedExperience(); track exp.id) {
              <div class="flex gap-6 items-start">
                <div class="experience-icon-box shrink-0">
                  <i class="fa-solid" [class.fa-rocket]="$first" [class.fa-desktop]="!$first"></i>
                </div>
                <div>
                  <h4 class="font-bold text-white text-base mb-1">{{ exp.title }}</h4>
                  <div class="text-subtext text-sm mb-2">
                    {{ exp.company }} <span class="mx-2 opacity-30">•</span>
                    {{ toDate(exp.startDate) ? (toDate(exp.startDate) | date:'yyyy') : 'N/A' }} – {{ exp.endDate &&
                    toDate(exp.endDate) ? (toDate(exp.endDate) | date:'yyyy') : "Aujourd'hui" }}
                  </div>
                  <div class="text-white/50 text-sm leading-relaxed max-w-xl quill-content"
                    [innerHTML]="exp.description | sanitizeQuill"></div>
                </div>
              </div>
              }
            </div>
          </section>

          <!-- FORMATION / ÉDUCATION -->
          @if (expertData()?.education && expertData()!.education!.length > 0) {
          <section>
            <h3 class="section-title">Formation</h3>
            <div class="space-y-10">
              @for (edu of sortedEducation(); track edu.id) {
              <div class="flex gap-6 items-start">
                <div class="experience-icon-box shrink-0">
                  <i class="fa-solid fa-graduation-cap"></i>
                </div>
                <div>
                  <h4 class="font-bold text-white text-base mb-1">{{ edu.degree }}</h4>
                  <div class="text-primary text-sm mb-1">
                    {{ edu.school }}
                  </div>
                  <div class="text-subtext text-sm mb-2">
                    {{ edu.fieldOfStudy }} <span class="mx-2 opacity-30">•</span>
                    {{ toDate(edu.startDate) ? (toDate(edu.startDate) | date:'yyyy') : 'N/A' }} – {{ edu.endDate &&
                    toDate(edu.endDate) ? (toDate(edu.endDate) | date:'yyyy') : "En cours" }}
                  </div>
                  @if (edu.description) {
                  <div class="text-white/50 text-sm leading-relaxed max-w-xl quill-content"
                    [innerHTML]="edu.description | sanitizeQuill"></div>
                  }
                </div>
              </div>
              }
            </div>
          </section>
          }

          <!-- Bottom actions (desktop only — mobile has sticky bar) -->
          <div class="hidden md:flex flex-wrap gap-4 pt-4 border-t border-white/5">
            <button (click)="goBack()"
              class="bg-white/5 border border-white/10 text-white px-8 py-3 rounded-full font-bold uppercase tracking-widest text-[11px] hover:bg-white/10 transition-colors duration-300 flex items-center gap-2">
              <i class="fa-solid fa-arrow-left text-xs"></i>
              Retour aux experts
            </button>
            <button (click)="onHire()"
              class="bg-primary text-white px-8 py-3 rounded-full font-bold uppercase tracking-widest text-[11px] shadow-[0_0_20px_-5px_rgba(236,72,153,0.5)] hover:bg-primary-hover transition-colors duration-300 flex items-center gap-2">
              <i class="fa-solid fa-paper-plane text-xs"></i>
              Proposer un projet
            </button>
          </div>

        </div>
      </div>

      <!-- RIGHT COLUMN: Sticky Sidebar (4/12) -->
      <div class="lg:col-span-4">
        <div class="sticky-sidebar">

          <!-- Main CTA Card -->
          <div class="sidebar-card mb-4">

            <!-- Availability Pill -->
            @if (expertData()?.isAvailable) {
            <div
              class="inline-flex items-center gap-2 px-3 py-1 bg-green-500/10 text-green-400 rounded-full text-[11px] font-bold mb-6 border border-green-500/20">
              <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>
              Disponible
            </div>
            } @else {
            <div
              class="inline-flex items-center gap-2 px-3 py-1 bg-white/5 text-subtext rounded-full text-[11px] font-bold mb-6 border border-white/10">
              <span class="w-1.5 h-1.5 rounded-full bg-subtext"></span>
              Non disponible
            </div>
            }

            <!-- Nom répété seulement sur desktop (déjà visible dans le titre sur mobile) -->
            <div class="hidden lg:block">
              <h3 class="text-xl font-bold text-white mb-1">{{ fullName() }}</h3>
              <p class="text-subtext text-sm mb-1">{{ jobTitle() }}</p>
              <p class="text-subtext text-xs mb-6">Réponse garantie sous {{ responseTime() }}.</p>
            </div>

            <button (click)="onHire()"
              class="w-full py-3 rounded-full bg-primary text-white font-bold text-[11px] uppercase tracking-widest shadow-[0_0_20px_-5px_rgba(236,72,153,0.5)] hover:bg-primary-hover transition-colors duration-300 mb-3 flex items-center justify-center gap-2">
              <i class="fa-solid fa-paper-plane text-xs"></i>
              Proposer un projet
            </button>
            <p class="text-[11px] text-center text-subtext mb-6 font-medium">Devis gratuit et sans engagement</p>

            <!-- Info Grid -->
            <div class="space-y-0">
              @if (expertData()?.availability?.types?.length) {
              <div class="sidebar-info-row items-start">
                <span class="label pt-1">Contrat</span>
                <div class="flex flex-wrap gap-1 justify-end">
                  @for (t of $any(expertData()!.availability.types); track t) {
                  <span class="text-[10px] font-bold px-2 py-0.5 rounded-full border"
                    [class]="t === 'freelance' ? 'bg-primary/10 text-primary border-primary/20' : t === 'cdi' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : 'bg-purple-500/10 text-purple-400 border-purple-500/20'">
                    {{ t === 'freelance' ? 'Freelance' : t === 'cdi' ? 'CDI' : 'Mentoring' }}
                  </span>
                  }
                </div>
              </div>
              }
              @if (expertData()?.availability?.dailyRate) {
              <div class="sidebar-info-row">
                <span class="label">TJM</span>
                <span class="value">{{ expertData()?.availability?.dailyRate }} / jour</span>
              </div>
              }
              <div class="sidebar-info-row">
                <span class="label">Mode</span>
                <span class="value">{{ workPreferenceLabel() }}</span>
              </div>
              @if (expertData()?.languages) {
              <div class="sidebar-info-row">
                <span class="label">Langues</span>
                <span class="value">{{ languages() }}</span>
              </div>
              }
            </div>

          </div>

          <!-- Garanties Card -->
          <div class="garantie-box">
            <ul class="space-y-3">
              <li class="flex items-center gap-3 text-sm text-white/70">
                <i class="fa-solid fa-circle-check text-primary text-[14px]"></i>
                <span class="font-medium">Identité vérifiée</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-white/70">
                <i class="fa-solid fa-circle-check text-primary text-[14px]"></i>
                <span class="font-medium">Charte Expert signée</span>
              </li>
              @if (expertData()?.verificationStatus === 'verified') {
              <li class="flex items-center gap-3 text-sm text-white/70">
                <i class="fa-solid fa-circle-check text-primary text-[14px]"></i>
                <span class="font-medium">K-bis vérifié</span>
              </li>
              }
            </ul>
          </div>

        </div>
      </div>
    </div>
    }
  </div>

  <!-- Proposal Modal -->
  @if (showProposalModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm transition-opacity" (click)="closeProposalModal()"></div>
    <div
      class="relative bg-surface border border-white/10 rounded-2xl shadow-xl w-full max-w-xl overflow-hidden transform transition-all animate-fadeInUp">

      @if (proposalSent()) {
      <div class="p-12 text-center">
        <div
          class="w-16 h-16 bg-primary/10 text-primary rounded-full flex items-center justify-center text-3xl mb-6 mx-auto border border-primary/20">
          <i class="fa-solid fa-check"></i>
        </div>
        <h4 class="text-2xl font-bold text-white mb-2">C'est envoyé !</h4>
        <p class="text-subtext text-sm leading-relaxed max-w-xs mx-auto">
          Votre proposition a été transmise à l'expert.
        </p>
      </div>
      } @else {
      <div class="px-8 pt-8 flex items-center justify-between mb-8">
        <h3 class="text-xl font-bold text-white">Nouvelle proposition</h3>
        <button (click)="closeProposalModal()" class="text-subtext hover:text-white transition-colors">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>

      <div class="px-8 pb-8">
        <form (submit)="$event.preventDefault(); submitProposal()" class="space-y-5">

          <div>
            <label class="block text-[10px] font-bold text-subtext uppercase tracking-widest mb-2">Titre du projet
              *</label>
            <input type="text" [value]="proposalForm().title" (input)="updateForm('title', $any($event.target).value)"
              placeholder="Ex: Refonte d'une application Angular"
              class="w-full px-4 py-3 rounded-full bg-white/5 border border-white/10 focus:border-primary/30 focus:outline-none transition-all text-sm font-medium text-white placeholder:text-subtext"
              required>
          </div>

          <div>
            <label class="block text-[10px] font-bold text-subtext uppercase tracking-widest mb-2">Description</label>
            <textarea [value]="proposalForm().description"
              (input)="updateForm('description', $any($event.target).value)" rows="3"
              placeholder="Décrivez votre projet et vos besoins..."
              class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 focus:border-primary/30 focus:outline-none transition-all text-sm font-medium text-white placeholder:text-subtext resize-none"></textarea>
          </div>

          <!-- Urgence -->
          <div>
            <label class="block text-[10px] font-bold text-subtext uppercase tracking-widest mb-2">Urgence</label>
            <div class="grid grid-cols-4 gap-2">
              @for (opt of priorityOptions; track opt.value) {
              <button type="button" (click)="updateForm('priority', opt.value)"
                class="py-2 px-2 rounded-xl border text-[10px] font-bold text-center transition-all"
                [class]="proposalForm().priority === opt.value ? 'border-primary bg-primary/10 text-white' : 'border-white/10 bg-white/5 text-subtext hover:border-white/20'">
                <div>{{ opt.label }}</div>
                <div class="text-[9px] font-normal opacity-70">{{ opt.desc }}</div>
              </button>
              }
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-[10px] font-bold text-subtext uppercase tracking-widest mb-2">Budget (€) <span
                  class="text-white/30 font-normal normal-case">optionnel</span></label>
              <input type="text" [value]="proposalForm().budget"
                (input)="updateForm('budget', $any($event.target).value)" placeholder="Ex: 10 000"
                class="w-full px-4 py-3 rounded-full bg-white/5 border border-white/10 focus:border-primary/30 focus:outline-none transition-all text-sm font-medium text-white placeholder:text-subtext">
            </div>
            <div>
              <label class="block text-[10px] font-bold text-subtext uppercase tracking-widest mb-2">Date de
                début</label>
              <input type="date" [value]="proposalForm().startDate"
                (input)="updateForm('startDate', $any($event.target).value)"
                class="w-full px-4 py-3 rounded-full bg-white/5 border border-white/10 focus:border-primary/30 focus:outline-none transition-all text-sm font-medium text-white">
            </div>
          </div>

          <!-- Email field: only shown when NOT logged in as recruiter -->
          @if (!isRecruiter()) {
          <div>
            <label class="block text-[10px] font-bold text-subtext uppercase tracking-widest mb-2">Votre email *</label>
            <input type="email" [value]="proposalForm().email" (input)="updateForm('email', $any($event.target).value)"
              placeholder="votre@email.com"
              class="w-full px-4 py-3 rounded-full bg-white/5 border border-white/10 focus:border-primary/30 focus:outline-none transition-all text-sm font-medium text-white placeholder:text-subtext">
          </div>
          }

          <!-- Auth-gate notice when not logged in as recruiter -->
          @if (!isRecruiter()) {
          <div class="flex items-start gap-3 p-4 rounded-2xl bg-primary/5 border border-primary/15">
            <i class="fa-solid fa-circle-info text-primary text-sm mt-0.5 flex-shrink-0"></i>
            <p class="text-xs text-subtext leading-relaxed">
              Vous pouvez remplir le formulaire maintenant. Au moment d'envoyer, vous serez invité à
              <span class="text-white font-semibold">vous connecter en tant que recruteur</span> — votre brouillon sera
              conservé.
            </p>
          </div>
          }

          <!-- Connected as recruiter: show identity confirmation -->
          @if (isRecruiter()) {
          <div class="flex items-center gap-3 p-3 rounded-2xl bg-green-500/5 border border-green-500/15">
            <i class="fa-solid fa-circle-check text-green-400 text-sm flex-shrink-0"></i>
            <p class="text-xs text-green-400 font-medium">Connecté en tant que recruteur — la proposition sera envoyée
              depuis votre compte.</p>
          </div>
          }

          <!-- Error message -->
          @if (proposalError()) {
          <div class="flex items-center gap-2 p-3 rounded-xl bg-red-500/10 border border-red-500/20">
            <i class="fa-solid fa-triangle-exclamation text-red-400 text-xs flex-shrink-0"></i>
            <p class="text-xs text-red-400">{{ proposalError() }}</p>
          </div>
          }

          <div class="pt-2">
            <button type="submit" [disabled]="isSubmitting()"
              class="w-full py-3 rounded-full bg-primary text-white font-bold text-[11px] uppercase tracking-widest shadow-[0_0_20px_-5px_rgba(236,72,153,0.5)] hover:bg-primary-hover transition-colors duration-300 flex items-center justify-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed">
              @if (isSubmitting()) {
              <i class="fa-solid fa-circle-notch fa-spin"></i>
              Envoi en cours...
              } @else if (isRecruiter()) {
              <i class="fa-solid fa-paper-plane text-xs"></i>
              Envoyer ma proposition
              } @else {
              <i class="fa-solid fa-lock text-xs"></i>
              Continuer &amp; se connecter
              }
            </button>
          </div>
        </form>
      </div>
      }
    </div>
  </div>
  }

  <!-- ─── Mobile sticky bottom bar ───────────────────────────────────────── -->
  <div
    class="fixed bottom-0 left-0 right-0 z-40 md:hidden bg-[#0f0f0f]/95 backdrop-blur-md border-t border-white/8 px-4 py-3 flex items-center gap-3">
    <button (click)="goBack()"
      class="flex-1 py-3 rounded-full bg-white/6 border border-white/10 text-white font-bold text-[11px] uppercase tracking-widest flex items-center justify-center gap-2">
      <i class="fa-solid fa-arrow-left text-xs"></i>
      Retour
    </button>
    <button (click)="onHire()"
      class="flex-1 py-3 rounded-full bg-primary text-white font-bold text-[11px] uppercase tracking-widest shadow-[0_0_20px_-5px_rgba(236,72,153,0.5)] flex items-center justify-center gap-2">
      <i class="fa-solid fa-paper-plane text-xs"></i>
      Proposer un projet
    </button>
  </div>

</div>