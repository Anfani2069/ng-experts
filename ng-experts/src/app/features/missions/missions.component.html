<app-dashboard-layout [pageTitle]="'Mes Missions'" [pageSubtitle]="'G√©rez vos propositions et missions'" [showSearch]="false">
  <div class="p-6 md:p-8 bg-heroBg min-h-full">

    <!-- Stats rapides -->
    <div class="grid grid-cols-2 sm:grid-cols-6 gap-4 mb-8">
      <div class="bg-[#1a1a1a] border border-white/5 rounded-2xl p-4 text-center">
        <i class="fa-solid fa-list text-primary text-lg mb-2 block"></i>
        <p class="text-2xl font-black text-white">{{ stats().total }}</p>
        <p class="text-[10px] text-subtext uppercase tracking-widest mt-1">Total</p>
      </div>
      <div class="bg-[#1a1a1a] border border-white/5 rounded-2xl p-4 text-center">
        <i class="fa-solid fa-clock text-yellow-400 text-lg mb-2 block"></i>
        <p class="text-2xl font-black text-white">{{ stats().pending }}</p>
        <p class="text-[10px] text-subtext uppercase tracking-widest mt-1">En attente</p>
      </div>
      <div class="bg-[#1a1a1a] border border-white/5 rounded-2xl p-4 text-center">
        <i class="fa-solid fa-check text-green-400 text-lg mb-2 block"></i>
        <p class="text-2xl font-black text-white">{{ stats().accepted }}</p>
        <p class="text-[10px] text-subtext uppercase tracking-widest mt-1">En cours</p>
      </div>
      <div class="bg-[#1a1a1a] border border-white/5 rounded-2xl p-4 text-center">
        <i class="fa-solid fa-flag-checkered text-blue-400 text-lg mb-2 block"></i>
        <p class="text-2xl font-black text-white">{{ stats().completed }}</p>
        <p class="text-[10px] text-subtext uppercase tracking-widest mt-1">Termin√©es</p>
      </div>
      <div class="bg-[#1a1a1a] border border-white/5 rounded-2xl p-4 text-center">
        <i class="fa-solid fa-xmark text-red-400 text-lg mb-2 block"></i>
        <p class="text-2xl font-black text-white">{{ stats().rejected }}</p>
        <p class="text-[10px] text-subtext uppercase tracking-widest mt-1">Refus√©es</p>
      </div>
      <div class="bg-[#1a1a1a] border border-orange-500/10 rounded-2xl p-4 text-center">
        <i class="fa-solid fa-hourglass-end text-orange-400 text-lg mb-2 block"></i>
        <p class="text-2xl font-black text-white">{{ stats().expired }}</p>
        <p class="text-[10px] text-subtext uppercase tracking-widest mt-1">Expir√©es</p>
      </div>
    </div>

    <!-- Filtres -->
    <div class="flex flex-wrap gap-2 mb-6">
      <button (click)="activeFilter.set('all')"
        [ngClass]="activeFilter() === 'all' ? 'bg-primary text-white' : 'bg-white/5 border border-white/10 text-subtext hover:bg-white/10'"
        class="px-4 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all">
        Toutes ({{ stats().total }})
      </button>
      <button (click)="activeFilter.set('pending')"
        [ngClass]="activeFilter() === 'pending' ? 'bg-yellow-500 text-black' : 'bg-white/5 border border-white/10 text-subtext hover:bg-white/10'"
        class="px-4 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all">
        En attente ({{ stats().pending }})
      </button>
      <button (click)="activeFilter.set('accepted')"
        [ngClass]="activeFilter() === 'accepted' ? 'bg-green-500 text-black' : 'bg-white/5 border border-white/10 text-subtext hover:bg-white/10'"
        class="px-4 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all">
        En cours ({{ stats().accepted }})
      </button>
      <button (click)="activeFilter.set('completed')"
        [ngClass]="activeFilter() === 'completed' ? 'bg-blue-500 text-white' : 'bg-white/5 border border-white/10 text-subtext hover:bg-white/10'"
        class="px-4 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all">
        Termin√©es ({{ stats().completed }})
      </button>
      <button (click)="activeFilter.set('rejected')"
        [ngClass]="activeFilter() === 'rejected' ? 'bg-red-500 text-white' : 'bg-white/5 border border-white/10 text-subtext hover:bg-white/10'"
        class="px-4 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all">
        Refus√©es ({{ stats().rejected }})
      </button>
      <button (click)="activeFilter.set('expired')"
        [ngClass]="activeFilter() === 'expired' ? 'bg-orange-500 text-white' : 'bg-white/5 border border-white/10 text-subtext hover:bg-white/10'"
        class="px-4 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all">
        Expir√©es ({{ stats().expired }})
      </button>
    </div>

    <!-- Loading -->
    @if (isLoading()) {
      <div class="flex flex-col items-center justify-center py-20 text-subtext">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-primary"></i>
        <p>Chargement de vos missions...</p>
      </div>
    } @else {

      <!-- Empty state -->
      @if (filteredProposals().length === 0) {
        <div class="bg-[#1a1a1a] border border-white/5 rounded-3xl p-12 text-center">
          <div class="w-20 h-20 bg-primary/10 border border-primary/20 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fa-solid fa-briefcase text-primary text-3xl"></i>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">
            @if (activeFilter() === 'all') { Aucune mission }
            @else if (activeFilter() === 'pending') { Aucune proposition en attente }
            @else if (activeFilter() === 'accepted') { Aucune mission en cours }
            @else if (activeFilter() === 'completed') { Aucune mission termin√©e }
            @else { Aucune mission refus√©e }
          </h3>
          <p class="text-subtext max-w-sm mx-auto">
            @if (activeFilter() === 'all') {
              Vous n'avez pas encore re√ßu de propositions. Compl√©tez votre profil pour attirer les recruteurs.
            } @else {
              Aucune proposition ne correspond √† ce filtre pour le moment.
            }
          </p>
          @if (activeFilter() === 'all') {
            <a routerLink="/profile-edit"
              class="inline-flex items-center gap-2 mt-6 px-6 py-3 bg-primary text-white rounded-full text-sm font-bold hover:bg-primary/80 transition">
              <i class="fa-solid fa-user-pen"></i>
              Compl√©ter mon profil
            </a>
          }
        </div>
      } @else {

      <!-- Liste des missions -->
      <div class="grid grid-cols-1 gap-5">
        @for (proposal of filteredProposals(); track proposal.id) {
          <div class="bg-[#1a1a1a] rounded-2xl p-6 transition-all"
            [class]="proposal.status === 'expired' ? 'border border-orange-500/20 opacity-70'
              : proposal.status === 'pending' && isExpiringSoon(proposal) ? 'border-2 border-red-500/40 shadow-[0_0_30px_-5px_rgba(239,68,68,0.15)]'
              : 'border border-white/5 hover:border-white/10'">

            <!-- ‚è∞ COUNTDOWN BANNER pour pending -->
            @if (proposal.status === 'pending') {
              <div class="mb-4 p-3 rounded-xl"
                [class]="isExpiringSoon(proposal) ? 'bg-red-500/10 border border-red-500/20' : 'bg-yellow-500/5 border border-yellow-500/10'">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <i class="fa-solid fa-stopwatch"
                      [class]="isExpiringSoon(proposal) ? 'text-red-400 animate-pulse' : 'text-yellow-400'"></i>
                    <span class="text-[11px] font-bold uppercase tracking-widest"
                      [class]="isExpiringSoon(proposal) ? 'text-red-400' : 'text-yellow-400'">
                      D√©lai de r√©ponse : 1 heure
                    </span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="font-mono font-black text-base tracking-wider"
                      [class]="isExpiringSoon(proposal) ? 'text-red-400' : 'text-yellow-300'">
                      {{ getCountdown(proposal) }}
                    </span>
                  </div>
                </div>
                <div class="w-full bg-white/5 rounded-full h-2 overflow-hidden">
                  <div class="h-full rounded-full transition-all duration-1000"
                    [class]="isExpiringSoon(proposal) ? 'bg-red-400' : 'bg-yellow-400'"
                    [style.width.%]="getCountdownPercent(proposal)">
                  </div>
                </div>
                @if (isExpiringSoon(proposal)) {
                  <p class="text-[10px] text-red-400/70 mt-1.5">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                    D√©p√™chez-vous ! Non-r√©ponse = strike ({{ freezeService.freezeStrikes() }}/3 avant gel du profil)
                  </p>
                }
              </div>
            }

            <!-- EXPIRED banner -->
            @if (proposal.status === 'expired') {
              <div class="mb-4 p-3 rounded-xl bg-orange-500/10 border border-orange-500/20 flex items-center gap-3">
                <i class="fa-solid fa-hourglass-end text-orange-400 text-lg"></i>
                <div>
                  <span class="text-orange-400 text-[11px] font-bold uppercase tracking-widest">D√©lai d√©pass√© ‚Äî Non r√©pondu</span>
                  <p class="text-orange-300/50 text-[10px] mt-0.5">Un strike a √©t√© comptabilis√© sur votre profil.</p>
                </div>
              </div>
            }

            <div class="flex flex-col md:flex-row gap-5">

              <!-- Client Info (Gauche) -->
              <div class="md:w-56 flex-shrink-0 flex flex-col items-center md:items-start text-center md:text-left border-b md:border-b-0 md:border-r border-white/5 pb-4 md:pb-0 md:pr-6">
                <div class="w-14 h-14 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-white font-bold text-xl mb-3">
                  {{ (proposal.clientName || 'R').charAt(0).toUpperCase() }}
                </div>
                <h4 class="font-bold text-white text-sm truncate w-full" [title]="proposal.clientName || 'Recruteur'">
                  {{ proposal.clientName || 'Recruteur' }}
                </h4>
                <p class="text-xs text-subtext mt-0.5">Recruteur</p>
                <button (click)="openDetails(proposal)"
                  class="mt-3 text-[11px] font-bold uppercase tracking-widest text-primary hover:text-primary/70 transition">
                  Voir les d√©tails
                </button>
              </div>

              <!-- Mission Details (Centre) -->
              <div class="flex-1">
                <div class="flex items-start justify-between mb-3">
                  <h3 class="text-lg font-bold text-white">{{ proposal.title }}</h3>
                  <span class="inline-flex items-center gap-1.5 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider shrink-0 ml-3"
                    [class]="getStatusClass(proposal.status)">
                    <i [class]="getStatusIcon(proposal.status) + ' text-[8px]'"></i>
                    {{ getStatusLabel(proposal.status) }}
                  </span>
                </div>

                <div class="flex flex-wrap gap-4 text-sm text-subtext mb-4">
                  @if (proposal.priority && proposal.priority !== 'normal') {
                    <div class="flex items-center">
                      <span class="text-[10px] font-bold uppercase tracking-widest px-2.5 py-1 rounded-full border"
                        [class]="proposal.priority === 'urgent' ? 'bg-red-500/10 text-red-400 border-red-500/20' : proposal.priority === 'high' ? 'bg-orange-500/10 text-orange-400 border-orange-500/20' : 'bg-green-500/10 text-green-400 border-green-500/20'">
                        {{ proposal.priority === 'urgent' ? 'üî¥ Urgent' : proposal.priority === 'high' ? 'üü† √âlev√©' : 'üü¢ Faible' }}
                      </span>
                    </div>
                  }
                  @if (proposal.budget) {
                    <div class="flex items-center gap-2">
                      <i class="fa-solid fa-coins text-subtext text-xs"></i>
                      <span class="text-white font-semibold">{{ proposal.budget }}</span>
                    </div>
                  }
                  <div class="flex items-center gap-2">
                    <i class="fa-solid fa-calendar text-subtext text-xs"></i>
                    <span>D√©but : {{ proposal.startDate }}</span>
                  </div>
                  @if (toDate(proposal.createdAt)) {
                    <div class="flex items-center gap-2">
                      <i class="fa-solid fa-paper-plane text-subtext text-xs"></i>
                      <span>Re√ßue le {{ toDate(proposal.createdAt) | date:'dd/MM/yyyy' }}</span>
                    </div>
                  }
                </div>

                <div class="bg-white/5 rounded-xl p-4 mb-4">
                  <p class="text-subtext text-sm leading-relaxed line-clamp-2">{{ proposal.description }}</p>
                </div>

                <!-- Actions selon le statut -->
                <div class="flex flex-wrap gap-2">
                  @if (proposal.status === 'pending' && !isProposalExpired(proposal)) {
                    <button (click)="confirmAction('accepted', proposal)"
                      class="px-4 py-2 bg-green-500/10 border border-green-500/30 text-green-400 rounded-full text-[11px] font-bold uppercase tracking-widest hover:bg-green-500/20 transition-all">
                      <i class="fa-solid fa-check mr-1.5"></i>Accepter
                    </button>
                    <button (click)="confirmAction('rejected', proposal)"
                      class="px-4 py-2 bg-white/5 border border-white/10 text-subtext rounded-full text-[11px] font-bold uppercase tracking-widest hover:bg-red-500/10 hover:border-red-500/30 hover:text-red-400 transition-all">
                      <i class="fa-solid fa-xmark mr-1.5"></i>Refuser
                    </button>
                  }
                  @if (proposal.status === 'expired') {
                    <span class="px-4 py-2 bg-orange-500/10 border border-orange-500/20 text-orange-400 rounded-full text-[11px] font-bold uppercase tracking-widest">
                      <i class="fa-solid fa-hourglass-end mr-1.5"></i>Proposition expir√©e
                    </span>
                  }
                  @if (proposal.status === 'accepted') {
                    <button (click)="confirmAction('completed', proposal)"
                      class="px-4 py-2 bg-blue-500/10 border border-blue-500/30 text-blue-400 rounded-full text-[11px] font-bold uppercase tracking-widest hover:bg-blue-500/20 transition-all">
                      <i class="fa-solid fa-flag-checkered mr-1.5"></i>Cl√¥turer la mission
                    </button>
                    <button (click)="contactRecruiter(proposal)"
                      class="px-4 py-2 bg-white/5 border border-white/10 text-subtext rounded-full text-[11px] font-bold uppercase tracking-widest hover:border-primary/30 hover:text-primary transition-all">
                      <i class="fa-regular fa-envelope mr-1.5"></i>Contacter
                    </button>
                  }
                  @if (proposal.status === 'completed') {
                    <span class="px-4 py-2 bg-blue-500/10 border border-blue-500/30 text-blue-400 rounded-full text-[11px] font-bold uppercase tracking-widest">
                      <i class="fa-solid fa-check-double mr-1.5"></i>Mission termin√©e
                    </span>
                  }
                </div>
              </div>

            </div>
          </div>
        }
      </div>
      }
    }

  </div>

  <!-- DETAILS MODAL -->
  @if (selectedProposal(); as proposal) {
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" (click)="closeDetails()"></div>

      <div class="bg-[#1a1a1a] rounded-3xl w-full max-w-2xl shadow-2xl relative z-10 overflow-hidden">
        <div class="bg-primary px-8 py-6 text-white flex justify-between items-start">
          <div>
            <h2 class="text-2xl font-bold mb-1">{{ proposal.title }}</h2>
            <p class="text-white/80 text-sm">Propos√© par {{ proposal.clientName || 'Recruteur' }}</p>
          </div>
          <button (click)="closeDetails()" class="text-white/70 hover:text-white transition">
            <i class="fa-solid fa-xmark text-2xl"></i>
          </button>
        </div>

        <div class="p-8 max-h-[70vh] overflow-y-auto">
          <div class="grid grid-cols-2 gap-6 mb-8">
            <div class="p-4 bg-white/5 rounded-xl">
              <p class="text-xs text-subtext uppercase font-bold mb-1">Budget</p>
              <p class="text-xl font-bold text-white">{{ proposal.budget }}</p>
            </div>
            <div class="p-4 bg-white/5 rounded-xl">
              <p class="text-xs text-subtext uppercase font-bold mb-1">D√©marrage</p>
              <p class="text-xl font-bold text-white">{{ proposal.startDate }}</p>
            </div>
          </div>

          <div class="flex items-center gap-2 mb-6">
            <span class="text-[10px] font-bold uppercase tracking-widest px-3 py-1 rounded-full"
              [class]="getStatusClass(proposal.status)">
              <i [class]="getStatusIcon(proposal.status) + ' mr-1'"></i>
              {{ getStatusLabel(proposal.status) }}
            </span>
            @if (toDate(proposal.createdAt)) {
              <span class="text-xs text-subtext">
                Re√ßue le {{ toDate(proposal.createdAt) | date:'dd MMMM yyyy' }}
              </span>
            }
          </div>

          <h3 class="font-bold text-white mb-3">Description du projet</h3>
          <p class="text-subtext leading-relaxed mb-6 whitespace-pre-wrap">{{ proposal.description }}</p>

          <!-- Actions selon statut -->
          @if (proposal.status === 'pending') {
            <div class="flex gap-4 pt-6 border-t border-white/5">
              <button (click)="confirmAction('rejected', proposal); closeDetails()"
                class="flex-1 py-3 bg-white/5 border border-white/10 text-subtext font-bold rounded-xl hover:bg-red-500/10 hover:border-red-500/30 hover:text-red-400 transition-colors">
                Refuser
              </button>
              <button (click)="confirmAction('accepted', proposal); closeDetails()"
                class="flex-1 py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary/80 transition-colors shadow-lg shadow-primary/30">
                Accepter
              </button>
            </div>
          }
          @if (proposal.status === 'accepted') {
            <div class="flex gap-4 pt-6 border-t border-white/5">
              <button (click)="contactRecruiter(proposal)"
                class="flex-1 py-3 bg-white/5 border border-white/10 text-subtext font-bold rounded-xl hover:bg-primary/10 hover:border-primary/30 hover:text-primary transition-colors flex items-center justify-center gap-2">
                <i class="fa-solid fa-message"></i>
                Contacter le recruteur
              </button>
              <button (click)="confirmAction('completed', proposal); closeDetails()"
                class="flex-1 py-3 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition-colors shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2">
                <i class="fa-solid fa-flag-checkered"></i>
                Cl√¥turer la mission
              </button>
            </div>
          }
          @if (proposal.status === 'completed') {
            <div class="pt-6 border-t border-white/5 text-center">
              <span class="inline-flex items-center gap-2 px-6 py-3 bg-blue-500/10 text-blue-400 border border-blue-500/20 rounded-xl font-bold">
                <i class="fa-solid fa-check-double"></i>
                Cette mission est termin√©e
              </span>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- CONFIRMATION MODAL -->
  @if (showConfirmModal(); as action) {
    <div class="fixed inset-0 z-[60] flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" (click)="closeConfirmModal()"></div>

      <div class="bg-[#1a1a1a] rounded-2xl shadow-xl w-full max-w-sm relative z-10 overflow-hidden">
        <div class="p-6 text-center">
          <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"
            [ngClass]="{
              'bg-green-500/10 text-green-400': action.type === 'accepted',
              'bg-blue-500/10 text-blue-400': action.type === 'completed',
              'bg-red-500/10 text-red-400': action.type === 'rejected'
            }">
            @if (action.type === 'accepted') { <i class="fa-solid fa-check text-3xl"></i> }
            @else if (action.type === 'completed') { <i class="fa-solid fa-flag-checkered text-3xl"></i> }
            @else { <i class="fa-solid fa-xmark text-3xl"></i> }
          </div>

          <h3 class="text-xl font-bold text-white mb-2">
            @if (action.type === 'accepted') { Accepter la mission ? }
            @else if (action.type === 'completed') { Cl√¥turer la mission ? }
            @else { Refuser la mission ? }
          </h3>
          <p class="text-subtext mb-6">
            @if (action.type === 'accepted') {
              En acceptant, cette mission passera dans vos missions en cours.
            } @else if (action.type === 'completed') {
              La mission sera marqu√©e comme termin√©e. Le recruteur sera notifi√©.
            } @else {
              √ätes-vous s√ªr de vouloir refuser cette opportunit√© ? Cette action est irr√©versible.
            }
          </p>

          <div class="flex gap-3">
            <button (click)="closeConfirmModal()"
              class="flex-1 py-2.5 bg-white/5 border border-white/10 text-subtext font-medium rounded-xl hover:bg-white/10 transition-colors">
              Annuler
            </button>
            <button (click)="executeAction()"
              [ngClass]="{
                'bg-green-600': action.type === 'accepted',
                'bg-blue-600': action.type === 'completed',
                'bg-red-600': action.type === 'rejected'
              }"
              class="flex-1 py-2.5 text-white font-bold rounded-xl transition-colors shadow-md flex justify-center items-center gap-2">
              @if (processingId()) {
                <i class="fa-solid fa-circle-notch fa-spin"></i>
              }
              @if (action.type === 'accepted') { Confirmer }
              @else if (action.type === 'completed') { Cl√¥turer }
              @else { Refuser }
            </button>
          </div>
        </div>
      </div>
    </div>
  }

</app-dashboard-layout>
