rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Utilisateurs ───────────────────────────────────────────────────────
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ── Propositions ───────────────────────────────────────────────────────
    match /proposals/{proposalId} {
      allow read: if request.auth != null && (
        resource.data.expertId == request.auth.uid ||
        resource.data.clientId == request.auth.uid
      );
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        resource.data.expertId == request.auth.uid ||
        resource.data.clientId == request.auth.uid
      );
    }

    // ── Notifications ──────────────────────────────────────────────────────
    match /notifications/{notifId} {
      // Lecture : uniquement le destinataire
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      // Création : tout utilisateur authentifié peut créer une notif pour quelqu'un d'autre
      allow create: if request.auth != null;
      // Mise à jour (marquer comme lu) : uniquement le destinataire
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // ── Conversations ──────────────────────────────────────────────────────
    match /conversations/{conversationId} {
      // Lecture : être participant
      allow read: if request.auth != null &&
        request.auth.uid in resource.data.participantIds;

      // Création : être dans la liste des participants
      allow create: if request.auth != null &&
        request.auth.uid in request.resource.data.participantIds;

      // Mise à jour : être participant (lastMessage, unreadCount, etc.)
      allow update: if request.auth != null &&
        request.auth.uid in resource.data.participantIds;

      // ── Messages ─────────────────────────────────────────────────────────
      match /messages/{messageId} {
        // Lecture : être participant de la conversation parente
        allow read: if request.auth != null &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;

        // Création : être participant ET être l'expéditeur
        allow create: if request.auth != null &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds &&
          request.resource.data.senderId == request.auth.uid;
      }
    }
  }
}
